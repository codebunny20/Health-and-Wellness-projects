<!doctype html>
<!--
  TAWT: Single-page, single-file web app for tracking daily wellness and milestones.
  - UI: Plain HTML/CSS, no frameworks.
  - State: Stored entirely in localStorage (no backend).
  - Tabs: Navigation uses [data-tab] to toggle <section> visibility.
  - Reports: Derived metrics + simple canvas sparklines (no chart libs).
-->
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TAWT - Transition & Wellness Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* Design tokens used app-wide (dark theme) */
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --muted: #94a3b8;
      --text: #e5e7eb;
      --accent: #34d399;
      --accent-2: #60a5fa;
      --danger: #f87171;
      --warn: #fbbf24;
      --border: #1f2937;
      --chip: #334155;
    }
    * { box-sizing: border-box }
    body {
      /* Background: layered radial gradients + solid fallback */
      margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: radial-gradient(1200px 1200px at -10% -10%, #172554 5%, transparent 40%),
                  radial-gradient(1400px 1400px at 110% -10%, #1e293b 5%, transparent 40%),
                  var(--bg);
      color: var(--text);
    }
    header {
      /* Sticky header with translucent backdrop + blur */
      position: sticky; top: 0; z-index: 10;
      background: rgba(2,6,23,.7); backdrop-filter: blur(8px);
      border-bottom: 1px solid var(--border);
    }
    .wrap { /* Centered content column with max width */ max-width: 980px; margin: 0 auto; padding: 16px; }
    h1 { margin: 0; font-size: 20px; font-weight: 700; letter-spacing: .3px; }
    nav { /* Tab buttons container */ display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap; }
    nav button { /* Unstyled buttons + custom styles */ all: unset; cursor: pointer; padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border); background: #0b1220; color: var(--text); font-weight: 600; }
    nav button.active { /* Active tab state */ border-color: transparent; background: linear-gradient(135deg, #22c55e33, #3b82f633); }
    main { padding: 16px; }
    section { /* Sections act like tab panels */ display: none; }
    section.active { /* Only active tab panel is visible */ display: block; }

    /* Layout utilities (12-col CSS grid, responsive spans) */
    .grid { display: grid; gap: 12px; grid-template-columns: repeat(12, 1fr); }
    .card { /* Panel style with subtle gradient + border/shadow */ grid-column: span 12; background: linear-gradient(180deg, #0b1324, #0a1020); border: 1px solid var(--border); border-radius: 12px; padding: 14px; box-shadow: 0 10px 30px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.03); }
    @media (min-width: 760px) {
      /* Responsive column spans for cards */
      .span-6 { grid-column: span 6; }
      .span-4 { grid-column: span 4; }
      .span-8 { grid-column: span 8; }
    }

    .row { /* Form row grid */ display: grid; grid-template-columns: repeat(12, 1fr); gap: 10px; align-items: end; }
    .field { /* Stack label/input/hints */ grid-column: span 12; display: flex; flex-direction: column; gap: 6px; }
    @media (min-width: 700px) { /* Field spans on larger screens */ .field.span-4 { grid-column: span 4 } .field.span-3 { grid-column: span 3 } .field.span-6 { grid-column: span 6 } }
    label { font-size: 12px; color: var(--muted); }
    input, select, textarea { /* Themed inputs */ background: #0b1220; color: var(--text); border: 1px solid var(--border); padding: 10px 12px; border-radius: 8px; outline: none; }
    input[type="range"] { padding: 0 }
    textarea { min-height: 80px; resize: vertical }

    .hint { /* Muted helper text */ font-size: 12px; color: var(--muted) }
    .btn { /* Primary button gradient */ all: unset; cursor: pointer; background: linear-gradient(135deg, #22c55e, #16a34a); color: #021; padding: 10px 14px; border-radius: 10px; font-weight: 700; text-align: center; }
    .btn.secondary { background: linear-gradient(135deg, #60a5fa, #3b82f6); color: #021; }
    .btn.ghost { background: #0b1220; color: var(--text); border: 1px solid var(--border); }
    .btn.danger { background: linear-gradient(135deg, #f87171, #ef4444); color: #2b0b0b; }

    .list { /* Stack list of items */ display: grid; gap: 8px; margin-top: 10px; }
    .item { /* List item card layout */ display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center; background: #0b1220; border: 1px solid var(--border); border-radius: 10px; padding: 10px 12px; }

    .chips { /* Inline tags for quick facts */ display: flex; gap: 6px; flex-wrap: wrap }
    .chip { background: var(--chip); color: #cbd5e1; padding: 2px 8px; border-radius: 999px; font-size: 12px; }

    .stats { /* KPI grid */ display: grid; gap: 8px; grid-template-columns: repeat(3, 1fr); }
    .kpi { /* KPI card */ background: #0b1220; border: 1px solid var(--border); border-radius: 10px; padding: 12px }

    .muted { /* Subtle text */ color: var(--muted) }
    .right { /* Right-aligned inline actions */ display: flex; gap: 8px; align-items: center }

    /* Canvas is sized via attrs; CSS width/height only for display */
    canvas { width: 100%; height: 60px; }

    .sr-only { /* Visually hidden, accessible labels */ position: absolute; left: -9999px; width: 1px; height: 1px; overflow: hidden; }
  </style>
</head>
<body>
  <header>
    <!-- Tabs -->
    <div class="wrap">
      <h1>TAWT — Transition & Wellness Tracker</h1>
      <!-- TAB NAV BUTTONS -->
      <nav id="tabs">
        <!-- Button: Track tab -->
        <button data-tab="track" class="active" aria-controls="track" aria-selected="true">Track</button>
        <!-- Button: Milestones tab -->
        <button data-tab="milestones" aria-controls="milestones">Milestones</button>
        <!-- Add: Cycle tab -->
        <button data-tab="cycle" aria-controls="cycle">Cycle</button>
        <!-- Button: Reports tab (renders KPIs & sparkline on click) -->
        <button data-tab="reports" aria-controls="reports">Reports</button>
        <!-- Button: Settings tab -->
        <button data-tab="settings" aria-controls="settings">Settings</button>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <!-- Track tab: daily entry form and recent entries list -->
    <section id="track" class="active">
      <div class="grid">
        <div class="card span-8">
          <h2 style="margin-top:0">Daily Wellness</h2>
          <form id="entryForm">
            <div class="row">
              <div class="field span-3">
                <label for="entryDate">Date</label>
                <input id="entryDate" name="date" type="date" required />
              </div>
              <div class="field span-3">
                <label for="mood">Mood (1-5)</label>
                <input id="mood" name="mood" type="range" min="1" max="5" step="1" value="3" />
                <div class="hint">Value: <span id="moodVal">3</span></div>
              </div>
              <div class="field span-3">
                <label for="energy">Energy (1-5)</label>
                <input id="energy" name="energy" type="range" min="1" max="5" step="1" value="3" />
                <div class="hint">Value: <span id="energyVal">3</span></div>
              </div>
              <div class="field span-3">
                <label for="sleep">Sleep (hrs)</label>
                <input id="sleep" name="sleep" type="number" min="0" max="24" step="0.5" value="8" />
              </div>
              <div class="field span-6">
                <label for="medsName">
                  Medication/HRT <span class="muted">(optional)</span>
                </label>
                <div class="row" style="align-items:center">
                  <div class="field span-3">
                    <label class="sr-only" for="medsTaken">Taken?</label>
                    <select id="medsTaken">
                      <option value="">—</option>
                      <option value="yes">Taken</option>
                      <option value="no">Skipped</option>
                    </select>
                  </div>
                  <div class="field span-3">
                    <label class="sr-only" for="medsDose">Dose</label>
                    <input id="medsDose" placeholder="Dose (e.g., 2mg)" />
                  </div>
                  <div class="field span-6">
                    <label class="sr-only" for="medsName">Name</label>
                    <input id="medsName" placeholder="Name (e.g., Estradiol)" />
                  </div>
                  <div class="field span-3">
                    <label class="sr-only" for="medsTime">Time taken</label>
                    <input id="medsTime" type="time" />
                  </div>
                </div>
              </div>
              <div class="field span-12">
                <label for="notes">Notes</label>
                <textarea id="notes" placeholder="Symptoms, triggers, wins, etc."></textarea>
              </div>
            </div>
            <div class="right" style="margin-top:10px">
              <!-- Button: Save daily wellness entry -->
              <button type="submit" class="btn">Save Entry</button>
              <!-- Button: Reset daily wellness form -->
              <button type="button" id="resetForm" class="btn ghost">Reset</button>
            </div>
          </form>
        </div>

        <div class="card span-4">
          <h3 style="margin-top:0">Recent Entries</h3>
          <!-- Delete buttons for entries are created dynamically in renderEntries() -->
          <div id="entriesList" class="list" aria-live="polite"></div>
        </div>
      </div>
    </section>

    <!-- Milestones tab: add and review timeline items -->
    <section id="milestones">
      <div class="grid">
        <div class="card span-6">
          <h2 style="margin-top:0">Add Milestone</h2>
          <form id="milestoneForm">
            <div class="row">
              <div class="field span-4">
                <label for="msDate">Date</label>
                <input id="msDate" type="date" required />
              </div>
              <div class="field span-8">
                <label for="msTitle">Title</label>
                <input id="msTitle" placeholder="e.g., First appointment, Name change filed" required />
              </div>
              <div class="field span-12">
                <label for="msNote">Notes</label>
                <textarea id="msNote" placeholder="Any details you want to remember"></textarea>
              </div>
            </div>
            <div class="right">
              <!-- Button: Add milestone -->
              <button class="btn secondary" type="submit">Add Milestone</button>
              <!-- Button: Reset milestone form -->
              <button type="button" id="msReset" class="btn ghost">Reset</button>
            </div>
          </form>
        </div>

        <div class="card span-6">
          <h3 style="margin-top:0">Timeline</h3>
          <!-- Edit/Delete milestone buttons are created dynamically in renderMilestones() -->
          <div id="milestoneList" class="list" aria-live="polite"></div>
        </div>
      </div>
    </section>

    <!-- Add: Cycle tab -->
    <section id="cycle">
      <div class="grid">
        <div class="card span-6">
          <h2 style="margin-top:0">Cycle Tracker</h2>
          <form id="cycleForm">
            <div class="row">
              <div class="field span-6">
                <label for="cfStart">Start date (Day 1)</label>
                <input id="cfStart" type="date" required />
              </div>
              <div class="field span-6">
                <label for="cfEnd">End date <span class="muted">(optional)</span></label>
                <input id="cfEnd" type="date" />
              </div>
              <div class="field span-6">
                <label for="cfFlow">Flow <span class="muted">(optional)</span></label>
                <select id="cfFlow">
                  <option value="">—</option>
                  <option value="light">Light</option>
                  <option value="medium">Medium</option>
                  <option value="heavy">Heavy</option>
                </select>
              </div>
              <div class="field span-12">
                <label for="cfNotes">Notes</label>
                <textarea id="cfNotes" placeholder="Symptoms, mood, etc."></textarea>
              </div>
            </div>
            <div class="right" style="margin-top:10px">
              <button type="submit" class="btn">Save Cycle</button>
              <button type="button" id="cycleReset" class="btn ghost">Reset</button>
              <button type="button" id="cycleToday" class="btn secondary">Mark Today as Day 1</button>
            </div>
          </form>
        </div>

        <div class="card span-6">
          <h3 style="margin-top:0">Cycle Stats</h3>
          <div class="stats" style="grid-template-columns: repeat(2, 1fr);">
            <div class="kpi">
              <div class="muted">Avg Length</div>
              <div id="kpiAvgCycle" style="font-size:22px;font-weight:800">-</div>
            </div>
            <div class="kpi">
              <div class="muted">Next Start</div>
              <div id="kpiNextStart" style="font-size:22px;font-weight:800">-</div>
            </div>
          </div>
          <h3 style="margin:14px 0 6px">Recent Cycles</h3>
          <div id="cycleList" class="list" aria-live="polite"></div>
        </div>
      </div>
    </section>

    <!-- Reports tab: derived metrics and sparkline visualizations -->
    <section id="reports">
      <div class="grid">
        <div class="card span-12">
          <h2 style="margin-top:0">Last 7 Days Overview</h2>
          <div class="right" style="margin-bottom:10px">
            <!-- Button: Reset reports view -->
            <button type="button" id="resetReports" class="btn ghost">Reset</button>
            <!-- Added: Range selector -->
            <select id="reportRange" style="background:#0b1220;border:1px solid var(--border);color:var(--text);padding:6px 8px;border-radius:6px">
              <option value="7" selected>Last 7</option>
              <option value="14">Last 14</option>
              <option value="30">Last 30</option>
            </select>
          </div>
          <!-- KPI values -->
          <div class="stats">
            <div class="kpi"><div class="muted">Mood</div><div id="kpiMood" style="font-size:22px;font-weight:800">-</div></div>
            <div class="kpi"><div class="muted">Energy</div><div id="kpiEnergy" style="font-size:22px;font-weight:800">-</div></div>
            <div class="kpi"><div class="muted">Sleep</div><div id="kpiSleep" style="font-size:22px;font-weight:800">-</div></div>
            <!-- Added KPI: Meds adherence -->
            <div class="kpi"><div class="muted">Adherence</div><div id="kpiAdherence" style="font-size:22px;font-weight:800">-</div></div>
            <!-- Added KPI: Mood variability -->
            <div class="kpi"><div class="muted">Mood SD</div><div id="kpiMoodSD" style="font-size:22px;font-weight:800">-</div></div>
          </div>
          <!-- Sparkline canvases -->
          <div style="margin-top:12px">
            <canvas id="spark" width="600" height="80" aria-label="Mood trend sparkline"></canvas>
            <div class="hint">Mood trend (selected range)</div>
          </div>
          <div style="margin-top:12px">
            <canvas id="energySpark" width="600" height="80" aria-label="Energy trend sparkline"></canvas>
            <div class="hint">Energy trend (selected range)</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Settings tab: import/export and data management -->
    <section id="settings">
      <div class="grid">
        <div class="card span-6">
          <h2 style="margin-top:0">Data</h2>
          <div class="right" style="margin-bottom:10px">
            <!-- Button: Export JSON data -->
            <button id="exportBtn" class="btn">Export JSON</button>
            <!-- Button: Clear all stored data -->
            <button id="clearBtn" class="btn danger">Clear All</button>
          </div>
          <label for="importBox">Import JSON</label>
            <!-- Button: Import JSON data -->
          <textarea id="importBox" placeholder='Paste previously exported JSON here'></textarea>
          <div class="right" style="margin-top:8px">
            <button id="importBtn" class="btn secondary">Import</button>
          </div>
          <p class="hint" id="dataInfo" style="margin-top:10px"></p>
        </div>

        <div class="card span-6">
          <h2 style="margin-top:0">About</h2>
          <p class="muted">
            Your data is stored locally in your browser via localStorage. No servers involved.
          </p>
          <ul class="muted">
            <li>Use Track to log daily wellness and meds.</li>
            <li>Use Milestones to record key steps in your transition.</li>
            <li>Reports shows 7-day averages and mood trend.</li>
            <li>Export regularly to back up.</li>
          </ul>
        </div>
      </div>
    </section>
  </main>

  <script>
    // ===== App architecture =====
    // - Tiny DOM helpers ($, $$)
    // - Utility formatters (fmt, todayISO, toISO) and uid() for ids
    // - State arrays: entries[], milestones[], cycles[] (persisted via localStorage)
    // - Renderers: renderEntries(), renderMilestones(), renderReports(), renderCycles()
    // - Event handlers: form submits, tab clicks, settings actions

    // DOM helpers and small utilities
    // $: querySelector, $$: querySelectorAll as array, fmt: format number or dash, todayISO: yyyy-mm-dd, toISO: parse->yyyy-mm-dd, uid: random id
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const fmt = (n, d=1) => Number.isFinite(n) ? n.toFixed(d) : '-';
    const todayISO = () => new Date().toISOString().slice(0,10);
    const toISO = (d) => new Date(d).toISOString().slice(0,10);
    const uid = () => Math.random().toString(36).slice(2, 9);

    // localStorage helpers: Keys + JSON-safe load/save
    const KEYS = { entries: 'tawt_entries', milestones: 'tawt_milestones', cycles: 'tawt_cycles' };
    const load = (k) => { try { return JSON.parse(localStorage.getItem(k) || '[]'); } catch { return []; } };
    const save = (k, v) => localStorage.setItem(k, JSON.stringify(v));

    // In-memory state mirrors localStorage; always save() after mutations
    let entries = load(KEYS.entries);
    let milestones = load(KEYS.milestones);
    let cycles = load(KEYS.cycles);

    // Tabs: delegate clicks on nav buttons; toggle .active on button and matching <section>; render reports lazily on tab open
    const tabs = $('#tabs');
    const sections = $$('main section');
    tabs.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-tab]');
      if (!btn) return;
      $$('nav button').forEach(b => b.classList.toggle('active', b === btn));
      sections.forEach(s => s.classList.toggle('active', s.id === btn.dataset.tab));
      btn.setAttribute('aria-selected', 'true');
      $$('nav button').forEach(b => { if (b!==btn) b.removeAttribute('aria-selected'); });
      if (btn.dataset.tab === 'reports') renderReports();
      if (btn.dataset.tab === 'cycle') renderCycles();
    });

    // Track form bindings: cache inputs and wire up live range value display
    const entryForm = $('#entryForm');
    const entryDate = $('#entryDate');
    const mood = $('#mood'); const moodVal = $('#moodVal');
    const energy = $('#energy'); const energyVal = $('#energyVal');
    const sleep = $('#sleep');
    const medsTaken = $('#medsTaken'), medsDose = $('#medsDose'), medsName = $('#medsName');
    const notes = $('#notes');
    const list = $('#entriesList');
    const medsTime = $('#medsTime');

    // Cache Settings/Reports elements instead of relying on global IDs
    const exportBtn = $('#exportBtn');
    const clearBtn  = $('#clearBtn');
    const importBtn = $('#importBtn');
    const importBox = $('#importBox');
    const dataInfo  = $('#dataInfo');
    const reportRangeEl = $('#reportRange');

    entryDate.value = todayISO();
    mood.addEventListener('input', () => moodVal.textContent = mood.value);
    energy.addEventListener('input', () => energyVal.textContent = energy.value);

    /**
     * Enable/disable meds-related inputs based on the "Taken?" dropdown.
     * - When "yes": enable fields and keep user input.
     * - Otherwise: disable and clear dose/name/time fields for data consistency.
     */
    function updateMedsFields() {
      const on = medsTaken.value === 'yes';
      [medsDose, medsName, medsTime].forEach(el => {
        el.disabled = !on;
        if (el.parentElement) el.parentElement.style.opacity = on ? '' : '.6';
      });
      if (!on) { medsDose.value = ''; medsName.value = ''; medsTime.value = ''; }
    }
    medsTaken.addEventListener('change', updateMedsFields);
    updateMedsFields();

    // Reset form: restores defaults (today, neutral sliders, typical sleep) and clears meds/notes
    $('#resetForm').addEventListener('click', () => {
      entryDate.value = todayISO();
      mood.value = 3; mood.dispatchEvent(new Event('input'));
      energy.value = 3; energy.dispatchEvent(new Event('input'));
      sleep.value = 8; medsTaken.value = ''; medsDose.value = ''; medsName.value = ''; medsTime.value = ''; notes.value = '';
      updateMedsFields();
    });

    // Save entry: build an entry object, dedupe per date (keep last), persist, re-render list, and keep form state in sync
    entryForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const entry = {
        id: uid(),
        date: entryDate.value || todayISO(),
        mood: +mood.value,
        energy: +energy.value,
        sleep: +sleep.value || 0,
        meds: {
          taken: medsTaken.value || null,
          dose: medsDose.value.trim() || null,
          name: medsName.value.trim() || null,
          time: medsTime.value || null
        },
        notes: notes.value.trim() || ''
      };
      // Deduplicate by date (keep last)
      entries = entries.filter(x => x.date !== entry.date);
      entries.push(entry);
      entries.sort((a,b) => a.date.localeCompare(b.date)); // ascending
      save(KEYS.entries, entries);
      renderEntries();
      entryForm.reset();
      entryDate.value = entry.date;
      mood.value = entry.mood; mood.dispatchEvent(new Event('input'));
      energy.value = entry.energy; energy.dispatchEvent(new Event('input'));
      sleep.value = entry.sleep;
      updateMedsFields();
    });

    /**
     * Render the 10 most recent entries (newest first).
     * - Shows chips for mood/energy/sleep and optional meds info.
     * - Adds a Delete button per item and wires its click to remove by id.
     */
    function renderEntries() {
      if (!entries.length) { list.innerHTML = '<div class="muted">No entries yet.</div>'; return; }
      const recent = [...entries].slice(-10).reverse();
      list.innerHTML = '';
      recent.forEach(e => {
        const div = document.createElement('div');
        div.className = 'item';
        const chips = [];
        chips.push(`<span class="chip">Mood ${e.mood}</span>`);
        chips.push(`<span class="chip">Energy ${e.energy}</span>`);
        chips.push(`<span class="chip">Sleep ${fmt(e.sleep,1)}h</span>`);
        if (e.meds?.taken) chips.push(`<span class="chip">${e.meds.taken === 'yes' ? 'Meds ✓' : 'Meds ⨯'}</span>`);
        if (e.meds?.name) chips.push(`<span class="chip">${e.meds.name}${e.meds?.dose ? ' • ' + e.meds.dose : ''}</span>`);
        if (e.meds?.time) chips.push(`<span class="chip">Time ${e.meds.time}</span>`);
        div.innerHTML = `
          <div>
            <div style="font-weight:700">${e.date}</div>
            <div class="chips" style="margin:6px 0">${chips.join('')}</div>
            ${e.notes ? `<div class="muted" style="white-space:pre-wrap">${e.notes}</div>` : ''}
          </div>
          <div class="right">
            <button class="btn danger" data-del="${e.id}">Delete</button>
          </div>
        `;
        list.appendChild(div);
      });
      list.querySelectorAll('[data-del]').forEach(btn => {
        // Button: Delete entry (removes by id, persists, re-renders)
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-del');
          entries = entries.filter(x => x.id !== id);
          save(KEYS.entries, entries);
          renderEntries();
        });
      });
    }

    // Milestones: cache inputs, default date to today
    const msForm = $('#milestoneForm');
    const msDate = $('#msDate'); const msTitle = $('#msTitle'); const msNote = $('#msNote');
    const msList = $('#milestoneList');
    msDate.value = todayISO();

    // Reset milestone form to defaults
    $('#msReset').addEventListener('click', () => {
      msDate.value = todayISO();
      msTitle.value = '';
      msNote.value = '';
    });

    // Add milestone: create record, sort chronologically, persist, refresh list
    msForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const m = { id: uid(), date: msDate.value || todayISO(), title: msTitle.value.trim(), note: msNote.value.trim() };
      if (!m.title) return;
      milestones.push(m);
      milestones.sort((a,b) => a.date.localeCompare(b.date));
      save(KEYS.milestones, milestones);
      msForm.reset(); msDate.value = m.date;
      renderMilestones();
    });

    /**
     * Render milestones (newest first) with Edit/Delete controls.
     * - Edit loads data back into the form and switches to the Milestones tab.
     * - Delete removes the item, persists, and re-renders.
     */
    function renderMilestones() {
      if (!milestones.length) { msList.innerHTML = '<div class="muted">No milestones yet.</div>'; return; }
      msList.innerHTML = '';
      [...milestones].reverse().forEach(m => {
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `
          <div>
            <div style="font-weight:700">${m.title}</div>
            <div class="muted">${m.date}</div>
            ${m.note ? `<div style="margin-top:6px; white-space:pre-wrap">${m.note}</div>` : ''}
          </div>
          <div class="right">
            <button class="btn ghost" data-ms-edit="${m.id}">Edit</button>
            <button class="btn danger" data-ms-del="${m.id}">Delete</button>
          </div>
        `;
        msList.appendChild(div);
      });
      msList.querySelectorAll('[data-ms-del]').forEach(b => b.addEventListener('click', () => {
        // Button: Delete milestone
        const id = b.getAttribute('data-ms-del');
        milestones = milestones.filter(x => x.id !== id);
        save(KEYS.milestones, milestones);
        renderMilestones();
      }));
      msList.querySelectorAll('[data-ms-edit]').forEach(b => b.addEventListener('click', () => {
        // Button: Edit milestone (loads data back into the form)
        const m = milestones.find(x => x.id === b.getAttribute('data-ms-edit'));
        if (!m) return;
        msDate.value = m.date; msTitle.value = m.title; msNote.value = m.note || '';
        // Switch tab
        $$('nav button').forEach(btn => btn.classList.toggle('active', btn.dataset.tab === 'milestones'));
        sections.forEach(s => s.classList.toggle('active', s.id === 'milestones'));
        // Move focus to the title for quick editing
        msTitle.focus();
      }));
    }

    // Reports helpers
    /**
     * lastNDays(n): filter entries whose date is within the last n days (inclusive), based on ISO yyyy-mm-dd string compare.
     */
    function lastNDays(n) {
      const cutoff = new Date(); cutoff.setDate(cutoff.getDate() - (n - 1));
      const iso = toISO(cutoff);
      return entries.filter(e => e.date >= iso);
    }
    /**
     * avg(arr, key): arithmetic mean of numeric arr[key], ignores non-finite values; returns NaN if no data.
     */
    function avg(arr, key) {
      const vals = arr.map(x => +x[key]).filter(Number.isFinite);
      if (!vals.length) return NaN;
      return vals.reduce((a,b) => a+b, 0) / vals.length;
    }

    // Standard deviation (population). Returns NaN if fewer than 2 values.
    function std(arr) {
      const vals = arr.filter(Number.isFinite);
      if (vals.length < 2) return NaN;
      const mean = vals.reduce((a,b) => a + b, 0) / vals.length;
      const variance = vals.reduce((a, x) => a + (x - mean) ** 2, 0) / vals.length;
      return Math.sqrt(variance);
    }

    /**
     * Render a simple area sparkline on a <canvas>.
     * - values: ordered numeric series
     * - min/max: y-scale domain (defaults 1..5)
     * Steps: clear -> scale -> stroke line (gradient) -> fill area -> draw dots.
     */
    function renderSparkline(canvas, values, { min=1, max=5 } = {}) {
      const ctx = canvas.getContext('2d');
      const w = canvas.width, h = canvas.height;
      ctx.clearRect(0,0,w,h);
      if (!values.length) return;
      const n = values.length;
      const pad = 6;
      const x = i => pad + (w - pad*2) * (i / (n - 1 || 1));
      const y = v => pad + (h - pad*2) * (1 - (v - min) / (max - min));
      // Gradient
      const grad = ctx.createLinearGradient(0,0,0,h);
      grad.addColorStop(0, '#34d399'); grad.addColorStop(1, '#3b82f6');
      ctx.lineWidth = 2; ctx.strokeStyle = grad; ctx.beginPath();
      ctx.moveTo(x(0), y(values[0]));
      for (let i=1;i<n;i++) ctx.lineTo(x(i), y(values[i]));
      ctx.stroke();
      // Fill
      ctx.lineTo(x(n-1), h - pad);
      ctx.lineTo(x(0), h - pad);
      ctx.closePath();
      ctx.fillStyle = 'rgba(52,211,153,0.10)';
      ctx.fill();
      // Dots
      ctx.fillStyle = '#60a5fa';
      values.forEach((v,i) => { ctx.beginPath(); ctx.arc(x(i), y(v), 2.5, 0, Math.PI*2); ctx.fill(); });
    }

    // Reset Reports: clears KPIs and wipes canvases for both mood and energy sparklines
    $('#resetReports').addEventListener('click', () => {
      $('#kpiMood').textContent = '-';
      $('#kpiEnergy').textContent = '-';
      $('#kpiSleep').textContent = '-';
      const c = $('#spark');
      const ctx = c.getContext('2d');
      ctx.clearRect(0, 0, c.width, c.height);
      $('#kpiAdherence').textContent = '-';
      $('#kpiMoodSD').textContent = '-';
      const ce = $('#energySpark')?.getContext('2d');
      if (ce) ce.clearRect(0,0,$('#energySpark').width,$('#energySpark').height);
    });

    /**
     * Compute and render report KPIs and sparklines for the selected range.
     * KPIs:
     * - Mood/Energy/Sleep: simple averages
     * - Adherence: % of entries with meds.taken === 'yes' among entries that specified taken
     * - Mood SD: standard deviation of mood values (requires std() helper)
     */
    function renderReports() {
      const days = +($('#reportRange')?.value || 7);
      const subset = lastNDays(days);
      $('#kpiMood').textContent = fmt(avg(subset, 'mood'), 1);
      $('#kpiEnergy').textContent = fmt(avg(subset, 'energy'), 1);
      $('#kpiSleep').textContent = fmt(avg(subset, 'sleep'), 1);
      // Adherence (% of entries with meds.taken === 'yes')
      const adherenceVals = subset.filter(e => e.meds && e.meds.taken);
      const taken = adherenceVals.filter(e => e.meds.taken === 'yes').length;
      const adherencePct = adherenceVals.length ? (100 * taken / adherenceVals.length) : NaN;
      $('#kpiAdherence').textContent = Number.isFinite(adherencePct) ? adherencePct.toFixed(0) + '%' : '-';
      // Mood variability (std dev)
      const moodVals = subset.map(e => e.mood).filter(Number.isFinite);
      $('#kpiMoodSD').textContent = fmt(std(moodVals), 2);

      // Mood sparkline (subset sequence)
      renderSparkline($('#spark'), moodVals);
      // Energy sparkline
      const energyVals = subset.map(e => e.energy).filter(Number.isFinite);
      renderSparkline($('#energySpark'), energyVals, { min:1, max:5 });
    }

    // Re-render when the range changes (7/14/30 days)
    reportRangeEl?.addEventListener('change', renderReports);

    // ===== Cycle Tracker =====
    // Cache Cycle elements
    const cycleForm = $('#cycleForm');
    const cfStart = $('#cfStart');
    const cfEnd = $('#cfEnd');
    const cfFlow = $('#cfFlow');
    const cfNotes = $('#cfNotes');
    const cycleList = $('#cycleList');
    const kpiAvgCycle = $('#kpiAvgCycle');
    const kpiNextStart = $('#kpiNextStart');

    // Defaults
    if (cfStart) cfStart.value = todayISO();

    $('#cycleReset')?.addEventListener('click', () => {
      if (!cfStart) return;
      cfStart.value = todayISO();
      cfEnd.value = '';
      cfFlow.value = '';
      cfNotes.value = '';
    });
    $('#cycleToday')?.addEventListener('click', () => {
      if (!cfStart) return;
      cfStart.value = todayISO();
    });

    // Helpers
    function daysBetween(aISO, bISO) {
      const a = new Date(aISO); const b = new Date(bISO);
      return Math.round((b - a) / (1000*60*60*24));
    }
    function addDays(iso, d) {
      const x = new Date(iso); x.setDate(x.getDate() + d);
      return x.toISOString().slice(0,10);
    }
    function avgCycleLength(startDates) {
      if (startDates.length < 2) return NaN;
      let diffs = 0, n = 0;
      for (let i=1;i<startDates.length;i++) {
        diffs += daysBetween(startDates[i-1], startDates[i]);
        n++;
      }
      return diffs / n;
    }

    // Save cycle
    cycleForm?.addEventListener('submit', (e) => {
      e.preventDefault();
      const start = cfStart.value;
      if (!start) return;
      let end = cfEnd.value || null;
      if (end && end < start) end = null; // ignore invalid end
      const c = {
        id: uid(),
        start,
        end,
        flow: cfFlow.value || null,
        notes: (cfNotes.value || '').trim()
      };
      cycles.push(c);
      cycles.sort((a,b) => (a.start || '').localeCompare(b.start || ''));
      save(KEYS.cycles, cycles);
      renderCycles();
      cycleForm.reset();
      cfStart.value = c.start;
    });

    // Render cycles: stats + recent list
    function renderCycles() {
      // Stats
      const starts = cycles.map(c => c.start).filter(Boolean).sort((a,b) => a.localeCompare(b));
      const avgLen = avgCycleLength(starts);
      kpiAvgCycle && (kpiAvgCycle.textContent = Number.isFinite(avgLen) ? `${avgLen.toFixed(1)}d` : '-');
      const lastStart = starts[starts.length - 1];
      const nextLen = Number.isFinite(avgLen) ? Math.round(avgLen) : 28;
      kpiNextStart && (kpiNextStart.textContent = lastStart ? addDays(lastStart, nextLen) : '-');

      // List
      if (!cycleList) return;
      if (!cycles.length) {
        cycleList.innerHTML = '<div class="muted">No cycles yet.</div>';
        return;
      }
      cycleList.innerHTML = '';
      [...cycles].slice(-10).reverse().forEach(c => {
        const chips = [];
        chips.push(`<span class="chip">Start ${c.start}</span>`);
        if (c.end) chips.push(`<span class="chip">End ${c.end}</span>`);
        if (c.start && c.end) chips.push(`<span class="chip">Length ${daysBetween(c.start, c.end) + 1}d</span>`);
        if (c.flow) chips.push(`<span class="chip">${c.flow[0].toUpperCase()}${c.flow.slice(1)}</span>`);
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `
          <div>
            <div class="chips" style="margin:6px 0">${chips.join('')}</div>
            ${c.notes ? `<div class="muted" style="white-space:pre-wrap">${c.notes}</div>` : ''}
          </div>
          <div class="right">
            <button class="btn danger" data-cy-del="${c.id}">Delete</button>
          </div>
        `;
        cycleList.appendChild(div);
      });
      cycleList.querySelectorAll('[data-cy-del]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-cy-del');
          cycles = cycles.filter(x => x.id !== id);
          save(KEYS.cycles, cycles);
          renderCycles();
        });
      });
    }

    // Settings: export/import/clear and storage footprint
    /**
     * updateDataInfo(): shows counts and approximate serialized size in KB.
     */
    function updateDataInfo() {
      const bytes = new Blob([JSON.stringify({ entries, milestones, cycles })]).size;
      const kb = (bytes/1024).toFixed(1);
      dataInfo.textContent = `Entries: ${entries.length} • Milestones: ${milestones.length} • Cycles: ${cycles.length} • Size: ${kb} KB`;
    }

    // Export JSON: downloads a pretty-printed backup with date-stamped filename
    exportBtn.addEventListener('click', () => {
      const payload = { exportedAt: new Date().toISOString(), entries, milestones, cycles };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `tawt-backup-${todayISO()}.json`;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(a.href);
    });

    // Import JSON: validates shape (entries/milestones arrays), persists, re-renders, updates stats
    importBtn.addEventListener('click', () => {
      if (!importBox.value.trim()) return;
      try {
        const data = JSON.parse(importBox.value);
        if (!Array.isArray(data.entries) || !Array.isArray(data.milestones)) throw new Error('Invalid data');
        const byDate = (a, b) => (a?.date || '').localeCompare(b?.date || '');
        entries = [...data.entries].sort(byDate);
        milestones = [...data.milestones].sort(byDate);
        // Add: cycles (optional in older backups)
        if (Array.isArray(data.cycles)) {
          const byStart = (a, b) => (a?.start || '').localeCompare(b?.start || '');
          cycles = [...data.cycles].sort(byStart);
        } else {
          cycles = [];
        }
        save(KEYS.entries, entries); save(KEYS.milestones, milestones); save(KEYS.cycles, cycles);
        renderEntries(); renderMilestones(); renderReports(); renderCycles(); updateDataInfo();
        importBox.value = '';
        alert('Import successful.');
      } catch (e) {
        alert('Import failed: ' + e.message);
      }
    });

    // Clear All: wipes both datasets after confirmation, then re-renders and updates stats
    clearBtn.addEventListener('click', () => {
      if (!confirm('Clear all data? This cannot be undone.')) return;
      entries = []; milestones = []; cycles = [];
      save(KEYS.entries, entries); save(KEYS.milestones, milestones); save(KEYS.cycles, cycles);
      renderEntries(); renderMilestones(); renderReports(); renderCycles(); updateDataInfo();
    });

    // Initial render: hydrate UI from localStorage
    renderEntries();
    renderMilestones();
    renderReports();
    renderCycles();
    updateDataInfo();
  </script>
</body>
</html>
